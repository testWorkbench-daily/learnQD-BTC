# 性能日志使用指南

## 概述

为了帮助识别性能瓶颈，系统已在所有核心模块添加了详细的计时日志。

## 添加的性能日志

### 1. bt_runner.py - 回测执行引擎

**Runner.run()方法** - 完整的回测流程计时：

```
⏱️  性能统计:
  数据加载: 0.52秒
  策略设置: 0.08秒
  回测执行: 45.32秒 ⭐  <- 最关键的性能指标
  基准回测: 43.18秒
  结果收集: 0.15秒
  保存数据: 0.42秒
  生成图表: 1.25秒
  总耗时: 91.12秒
  回测占比: 49.8%
```

**关键指标说明**：
- **回测执行**: Backtrader引擎运行策略的时间（通常占比最高）
- **基准回测**: 买入持有基准策略的执行时间
- **回测占比**: 策略回测时间占总时间的百分比

**_load_data()方法** - 数据加载详情：

当重采样耗时>0.1秒时，会打印：
```
    ├─ 数据读取: 0.45秒
    └─ 数据重采样: 0.07秒
```

**_run_benchmark()方法** - 基准回测详情：

当基准执行耗时>1.0秒时，会打印：
```
    ├─ 基准设置: 0.05秒
    └─ 基准执行: 42.50秒
```

---

### 2. bt_main.py - 主入口

**程序总体计时**：

```
⏱️  Runner创建: 0.003秒

运行策略: sma_cross
...
[回测结果]
...

============================================================
⏱️  程序总耗时: 95.34秒
============================================================
```

**对比模式统计**（`--compare`）：

```
🔄 对比模式: 运行133个策略...

============================================================
⏱️  对比模式性能统计:
  策略总数: 133
  总耗时: 1245.3秒 (20.8分钟)
  平均每策略: 9.36秒
============================================================
```

---

### 3. rolling_atom_validator.py - 组合验证工具

**窗口级计时**：

```
窗口 1/5: 2020-01 ~ 2020-12
  [1/2] 运行实际回测...
      (实际回测耗时: 52.3秒)
  [2/2] 计算理论测试...
      (理论计算耗时: 0.15秒)
  实际: 收益15.2%, 夏普1.85, 交易45次
  理论: 收益16.8%, 夏普1.92, 交易120次
  差异: 收益-1.6%, 夏普-0.07, 交易-75次
  ⏱️  窗口总耗时: 52.5秒
```

**并行模式**（`--workers auto`）：

```
  [1/5] 窗口 1: 2020-01 ~ 2020-12
      (实际回测耗时: 48.1秒)
      (理论计算耗时: 0.12秒)
      实际: 收益15.2%, 夏普1.85
      理论: 收益16.8%, 夏普1.92
      ⏱️  窗口总耗时: 48.3秒
```

---

### 4. portfolio_backtest.py - 理论组合回测

**backtest_portfolio_from_daily_values()函数**：

当总耗时>0.5秒时，会打印：
```
      ├─ 数据加载: 0.352秒
      └─ 指标计算: 0.168秒
```

---

## 使用场景

### 场景1: 单策略回测性能分析

```bash
python bt_main.py --atom portfolio_rank3_combo --start 2020-01-01 --end 2024-12-31
```

**查看什么**：
- "回测执行"时间 → Backtrader引擎性能
- "基准回测"时间 → 如果与主策略时间相差很大，可能是策略复杂度问题
- "保存数据"时间 → I/O性能
- "回测占比" → 如果<40%，说明其他环节拖慢了整体速度

### 场景2: 对比模式性能分析

```bash
python bt_main.py --compare --start 2024-01-01 --end 2024-12-31
```

**查看什么**：
- "平均每策略"时间 → 评估是否有异常慢的策略
- "总耗时" → 评估是否需要并行优化

### 场景3: 组合验证性能分析

```bash
python rolling_atom_validator.py --atom portfolio_rank3_combo
```

**查看什么**：
- "实际回测耗时" vs "理论计算耗时" → 理论计算应该远快于实际回测
- "窗口总耗时" → 单个窗口的完整耗时
- 多个窗口的耗时对比 → 评估是否需要并行执行

---

## 性能优化建议

### 基于日志的优化路径

1. **如果"回测执行"时间很长（>60秒）**：
   - 检查策略逻辑是否有冗余计算
   - 考虑减少指标复杂度
   - 检查是否有不必要的循环

2. **如果"基准回测"时间接近"回测执行"**：
   - ✅ 正常情况，说明策略复杂度适中

3. **如果"基准回测"时间远小于"回测执行"**：
   - ⚠️ 策略可能过于复杂
   - 建议简化指标计算

4. **如果"数据加载"时间很长（>2秒）**：
   - 检查数据文件大小
   - 考虑数据缓存
   - 检查磁盘I/O性能

5. **如果"保存数据"时间很长（>3秒）**：
   - 检查生成的CSV文件大小
   - 考虑压缩或减少记录字段

6. **如果"生成图表"时间很长（>5秒）**：
   - 考虑使用`--no-plot`跳过绘图
   - 检查plot_utils.py的性能

---

## 实际案例分析

### 案例1: 5年期全数据回测（2020-2024）

**预期性能**：
```
⏱️  性能统计:
  数据加载: 2.8秒     <- 5年数据，约2.1M行
  策略设置: 0.1秒
  回测执行: 95.2秒 ⭐  <- 主要耗时
  基准回测: 89.5秒
  结果收集: 0.3秒
  保存数据: 1.2秒
  总耗时: 189.1秒 (3.2分钟)
  回测占比: 50.3%
```

**分析**：
- 回测执行占一半时间 → ✅ 合理
- 数据加载<3秒 → ✅ I/O性能良好
- 总耗时约3分钟 → ✅ 可接受

### 案例2: 1个月短期回测（2024-11）

**预期性能**：
```
⏱️  性能统计:
  数据加载: 0.5秒
  策略设置: 0.1秒
  回测执行: 1.8秒 ⭐
  基准回测: 1.5秒
  结果收集: 0.1秒
  保存数据: 0.2秒
  总耗时: 4.2秒
  回测占比: 42.9%
```

**分析**：
- 数据加载占比较高（约12%）→ 短期回测时相对固定开销
- 回测执行<2秒 → ✅ 非常快
- 总耗时<5秒 → ✅ 适合快速迭代测试

### 案例3: 组合验证5个窗口（年度滚动）

**预期性能**：
```
窗口 1/5: 2020-01 ~ 2020-12
  实际回测耗时: 48.3秒
  理论计算耗时: 0.15秒
  窗口总耗时: 48.5秒

窗口 2/5: 2021-01 ~ 2021-12
  实际回测耗时: 47.8秒
  理论计算耗时: 0.14秒
  窗口总耗时: 48.0秒

...

验证完成！总耗时: 242秒 (4.0分钟)
```

**分析**：
- 理论计算远快于实际回测（<1%）→ ✅ 符合预期
- 每个窗口约48秒 → ✅ 与单年回测相当
- 5窗口串行约4分钟 → 可考虑并行优化

---

## 性能基准参考

**硬件配置**（示例）：
- CPU: Apple M1/M2 (4核)
- RAM: 8GB+
- SSD: NVMe

**性能基准**：
- **1年d1数据**: 约15-20秒
- **5年d1数据**: 约90-120秒
- **1年h1数据**: 约30-45秒
- **1年m5数据**: 约60-90秒

**优化目标**：
- 单策略5年回测 < 2分钟 ✅
- 对比133策略 < 30分钟 ✅
- 组合验证5窗口 < 5分钟 ✅

---

## 常见问题

### Q1: 为什么有些日志不显示？

**A**: 部分详细日志只在耗时较长时显示，以避免日志过多。例如：
- `_load_data`: 重采样耗时>0.1秒才显示
- `_run_benchmark`: 执行耗时>1.0秒才显示
- `backtest_portfolio_from_daily_values`: 总耗时>0.5秒才显示

### Q2: 回测占比应该是多少？

**A**: 通常情况下：
- **长周期回测（5年）**: 40-60% 正常
- **短周期回测（1月）**: 30-50% 正常（因固定开销占比大）
- **如果<30%**: 建议检查其他环节的性能
- **如果>70%**: ✅ 策略逻辑高效，其他环节优化良好

### Q3: 如何优化整体性能？

**A**: 按优先级排序：
1. **优化策略逻辑** → 影响"回测执行"时间
2. **使用`--no-plot`和`--no-save`** → 减少I/O开销
3. **并行执行** → 对比模式和组合验证使用`--workers auto`
4. **数据预处理** → 确保数据文件清洁且格式正确
5. **升级硬件** → SSD + 多核CPU

---

## 日志输出示例

完整的单策略回测日志输出：

```bash
$ python bt_main.py --atom portfolio_rank3_combo --start 2024-01-01 --end 2024-12-31

⏱️  Runner创建: 0.003秒

运行策略: portfolio_rank3_combo
时间周期: d1
夏普统计周期: 按周统计 (1w)
初始资金: $100,000
----------------------------------------
    ├─ 数据读取: 0.52秒
    └─ 数据重采样: 0.08秒
    ├─ 基准设置: 0.05秒
    └─ 基准执行: 12.50秒

回测结果:
  最终资金: $114,330.00
  收益率: 14.33%
  年化收益: 14.33%
  年化波动率: 12.15%
  夏普比率: 2.24 ✓原生计算(按周统计)
  卡尔玛比率: 42.15
  最大回撤: -0.34%
  交易次数: 28
  胜率: 64.29%

基准对比 (买入并持有):
指标            策略         基准         超额
--------------------------------------------------------
收益率         14.33%       27.14%      -12.81%
年化收益率     14.33%       27.14%      -12.81%
年化波动率     12.15%       15.82%       -3.67%
夏普比率        2.24         1.51         0.73
卡尔玛比率     42.15         9.68        32.47
最大回撤       -0.34%       -2.80%       -2.46%

交易记录已保存: backtest_results/trades_portfolio_rank3_combo_d1_20240101_20241231.csv
每日价值已保存: backtest_results/daily_values_portfolio_rank3_combo_d1_20240101_20241231.csv

⏱️  性能统计:
  数据加载: 0.60秒
  策略设置: 0.09秒
  回测执行: 13.25秒 ⭐
  基准回测: 12.55秒
  结果收集: 0.18秒
  保存数据: 0.42秒
  总耗时: 27.09秒
  回测占比: 48.9%

============================================================
⏱️  程序总耗时: 27.12秒
============================================================
```

---

## 总结

性能日志已集成到所有核心模块，覆盖：
- ✅ 单策略回测（bt_main.py, bt_runner.py）
- ✅ 对比模式（bt_main.py）
- ✅ 组合验证（rolling_atom_validator.py）
- ✅ 理论回测（portfolio_backtest.py）

**使用这些日志可以**：
1. 快速定位性能瓶颈
2. 评估优化效果
3. 对比不同配置的性能差异
4. 为生产环境部署提供性能基准

**下一步**：
- 运行实际回测，查看日志输出
- 根据日志分析性能瓶颈
- 针对性优化慢速环节

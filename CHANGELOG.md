# 更新日志 (Changelog)

本文件记录项目的所有重要变更。

格式遵循 [Keep a Changelog](https://keepachangelog.com/zh-CN/1.0.0/)

---

## [3.1.0] - 2026-01-12

### 重大修复
修正批量回测脚本的关键缺陷，确保不同策略类型使用正确的时间周期。

### 修复 (Fixed)
- **批量脚本timeframe分配**: 修正 `run_all_strategies_2020_2024.sh` 统一使用d1的问题
  - 问题: 所有132个策略统一使用d1 timeframe运行
  - 影响: 日内策略（ORB、VWAP等）在日线数据上完全失效
  - 解决: 按策略类型智能分配timeframe（m5/h1/d1）

### 新增 (Added)
- **并发执行支持**: 批量脚本添加并发控制（默认8并发）
  - `PARALLEL_JOBS` 变量可配置并发数
  - 使用bash后台任务实现并发控制
  - 预期性能提升5-6倍

### 优化 (Changed)
- **策略timeframe映射** (基于策略设计原理):
  - 日内策略 (27个) → m5: ORB、日内动量/反转、VWAP
  - 趋势跟踪 (16个) → h1: SMA、Triple MA、ADX、MACD
  - 均值回归 (13个) → h1: RSI、Bollinger MR、CCI
  - 突破策略 (46个) → d1: Donchian、Keltner、ATR、Vol突破、New High/Low
  - 波动率策略 (15个) → d1: 恒定波动率、波动率扩张、波动率区制
  - 经典系统 (6个) → d1: 海龟交易系统

- **滚动验证流程**: 适配多timeframe场景
  - 建议按timeframe分组运行验证（m5/h1/d1）
  - 每个timeframe组生成独立的稳健组合排名

### 文档 (Documentation)
- 更新 `WORK_LOG.md` - 详细记录问题发现和解决过程
- 更新批量脚本注释 - 说明timeframe分配逻辑

### 技术细节
- 并发控制函数: `run_with_limit(timeframe, strategy)`
- 动态任务数检测: `jobs -r | wc -l`
- 分组等待机制: 每类策略完成后执行 `wait`
- 预计执行时间: 0.3-1小时（8核并发，2020-2024数据）

---

## [3.0.0] - 2026-01-08

### 重大更新
这是一次架构级别的升级，将系统从单一脚本重构为模块化的Strategy Atom架构。

### 新增 (Added)
- **核心架构**: Strategy Atom模式（bt_base.py, bt_runner.py, bt_main.py）
- **策略库**: 21个策略原子文件，涵盖137个策略类，132个已注册

#### 策略分类（6大类）
1. **趋势跟踪** (17个策略)
   - ADX趋势强度策略 (5个变体)
   - 三重均线策略 (4个变体)
   - SMA双均线策略 (4个变体)
   - MACD趋势策略 (4个变体)

2. **突破策略** (47个策略)
   - 唐奇安通道突破 (10个变体)
   - Keltner通道突破 (7个变体)
   - ATR突破 (8个变体)
   - 波动率突破 (8个变体)
   - 新高新低突破 (8个变体)
   - 开盘区间突破 (7个变体)
   - 布林带突破 (4个变体)

3. **均值回归** (17个策略)
   - RSI反转 (4个变体)
   - 布林带均值回归 (6个变体)
   - VWAP回归 (5个变体)
   - CCI通道 (6个变体)

4. **波动率策略** (15个策略)
   - 恒定波动率目标 (5个变体)
   - 波动率扩张 (5个变体)
   - 波动率择时 (5个变体)

5. **日内交易** (13个策略)
   - 日内动量 (8个变体)
   - 日内反转 (5个变体)

6. **经典系统** (6个策略)
   - 海龟交易系统 1 (3个变体)
   - 海龟交易系统 2 (3个变体)

#### 组合回测系统
- `analyze_correlation.py` - 策略相关性分析工具
- `portfolio_backtest.py` - 策略组合回测引擎
- 支持低相关性策略组合自动筛选
- 支持等权重组合回测

#### 数据分析增强
- `DailyValueRecorder` 分析器 - 记录每日组合价值
- 每日收益率和累积收益率计算
- 用于策略相关性分析的数据基础

#### 批处理工具
- `run_all_strategies_2024.sh` - 批量运行所有策略
- `strategy_commands_2024.txt` - 策略命令列表

### 优化 (Changed)
- **代码组织**: 所有策略移至 `atoms/` 目录
- **命令行界面**: 统一的CLI入口 (`bt_main.py`)
- **数据路径**: 改用相对路径，提高可移植性
- **交易记录**: 文件名包含日期范围，更清晰
- **持仓成本追踪**: 改进部分平仓的盈亏计算

### 文档 (Documentation)
- `ATOMS_INTEGRATION_SUMMARY.md` - 策略集成总结
- `PORTFOLIO_BACKTEST_GUIDE.md` - 组合回测完整指南
- `CLAUDE.md` - 项目上下文说明（供AI助手使用）
- 更新 README.md（需同步到3.0版本）

### 技术细节
- 基于Backtrader框架
- 支持7种时间周期 (m1/m5/m15/m30/h1/h4/d1)
- 自动数据重采样
- 灵活的位置管理器(Sizer)系统
- 完整的交易记录和日志

---

## [2.1.0] - 2024-12-21

### 重构 (Refactored)
- **画图模块独立**: 创建 `plot_utils.py` (274行)
  - `plot_backtest_results()` - 基础画图函数
  - `plot_with_custom_style()` - 自定义样式
  - `plot_and_save()` - 自动保存
  - `check_plot_requirements()` - 依赖检查
  - `get_available_styles()` - 样式列表

### 优化 (Changed)
- **主程序精简**: `backtrader_demo.py` 减少26行
- 移除装饰性标题框
- 简化命令行帮助输出
- 简化运行提示信息

### 文档 (Documentation)
- `USAGE.md` (322行) - 详细使用说明
- `REFACTORING_SUMMARY.md` - 重构总结文档
- 完善文档体系（6个主要文档）

### 改进 (Improved)
- 代码可维护性大幅提升
- 模块可复用性增强
- 用户体验更友好（输出更简洁）

---

## [2.0.0] - 2024-12-21

### 新增 (Added)
- **多时间周期支持**: m1/m5/m15/m30/h1/h4/d1
- **交易记录导出**: CSV格式，18个字段
- **可视化图表**: K线图、技术指标、买卖信号、资金曲线
- **命令行参数**: 灵活的配置选项

### 删除 (Removed)
- 所有模拟数据生成逻辑
- 测试用的虚拟数据代码

### 文档 (Documentation)
- `QUICK_START.md` - 快速开始指南
- `CSV_FILES_GUIDE.md` - CSV文件说明
- `FEATURES.md` - 功能特性详解
- `README_backtrader.md` - 完整技术文档

---

## [1.0.0] - 初始版本

### 新增 (Added)
- 基础回测框架
- 双均线交易策略
- 数据清洗脚本 (`quick_fix_data.py`)
- NQ期货1分钟历史数据（2020-2025）

### 功能 (Features)
- Backtrader回测引擎集成
- 基本的策略回测功能
- 数据质量验证

---

## 版本号说明

格式: `主版本.次版本.修订号`

- **主版本**: 架构级别的重大变更（如1.x → 2.x → 3.x）
- **次版本**: 新功能添加或重要改进（如3.0 → 3.1）
- **修订号**: Bug修复或小优化（如3.0.0 → 3.0.1）

---

## 未来计划

### 短期 (v3.1.x)
- [ ] 参数优化功能
- [ ] 策略性能对比报告
- [ ] Web界面展示
- [ ] 更多技术指标支持

### 中期 (v3.2.x)
- [ ] 在线策略监控
- [ ] 风险管理模块
- [ ] 多品种回测支持
- [ ] 机器学习策略集成

### 长期 (v4.0)
- [ ] 策略工厂系统
- [ ] 自动化策略生成
- [ ] 实盘交易接口
- [ ] 云平台部署

---

**最后更新**: 2026-01-09
**当前版本**: 3.0.0
**项目状态**: ✅ 活跃开发

# Backtrader NQ期货回测系统

## 文件说明

### 1. 数据文件
- `btc_m1_all_backtrader.csv` - 原始NQ期货分钟数据（包含数据质量问题）
- `btc_m1_cleaned.csv` - 清洗后的数据（**推荐使用**）

### 2. Python脚本
- `clean_btc_data.py` - 数据清洗脚本
- `backtrader_demo.py` - 完整的回测系统

## 使用方法

### 第一步：数据清洗（已完成）

```bash
python clean_btc_data.py
```

清洗操作包括：
- ✅ 删除 184,381 行负数价格数据
- ✅ 合并 849,396 个重复时间戳
- ✅ 只保留 2020年1月1日后的数据
- ✅ 最终得到 2,108,305 行干净数据

### 第二步：运行回测

```bash
# 使用默认参数（2024年全年，1分钟K线）
python backtrader_demo.py

# 使用5分钟K线
python backtrader_demo.py --timeframe m5

# 使用1小时K线，指定时间范围
python backtrader_demo.py --timeframe h1 --start 2024-01-01 --end 2024-06-30

# 使用日线K线
python backtrader_demo.py --timeframe d1 --start 2020-01-01 --end 2024-12-31

# 查看所有参数
python backtrader_demo.py --help
```

### 命令行参数

| 参数 | 说明 | 默认值 | 示例 |
|------|------|--------|------|
| `--start` | 开始日期 | 2024-01-01 | `--start 2023-01-01` |
| `--end` | 结束日期 | 2024-12-31 | `--end 2024-06-30` |
| `--timeframe` | K线周期 | m1 | `--timeframe h1` |
| `--data` | 数据文件 | btc_m1_cleaned.csv | `--data mydata.csv` |

### K线周期选项

| 参数值 | K线周期 | 策略参数（快/慢） | 推荐使用场景 |
|--------|---------|------------------|--------------|
| `m1` | 1分钟 | 20/60 | 高频交易、日内短线 |
| `m5` | 5分钟 | 20/60 | 日内短线交易 |
| `m15` | 15分钟 | 15/45 | 日内波段交易 |
| `m30` | 30分钟 | 10/30 | 日内波段交易 |
| `h1` | 1小时 | 10/30 | 短期趋势跟踪 |
| `h4` | 4小时 | 5/15 | 中期趋势跟踪 |
| `d1` | 日线 | 5/20 | 长期趋势跟踪 |

## 回测结果示例

### 1分钟K线（2024年全年）
```
初始资金: $100,000.00
最终资金: $163,824.04
总收益: $63,824.04
收益率: 63.82%

总交易次数: 2177
盈利交易: 527 (24.22%)
亏损交易: 1649
平均盈利: $7,396.40
平均亏损: -$2,325.08
最大回撤: 98.91%
```

### 5分钟K线（2024年6月）
```
初始资金: $100,000.00
最终资金: $138,414.18
总收益: $38,414.18
收益率: 38.41%

总交易次数: 149
盈利交易: 47 (31.54%)
亏损交易: 102
最大回撤: 65.77%
```

### 日线K线（2023-2024年）
```
初始资金: $100,000.00
最终资金: $56,140.77
总收益: -$43,859.23
收益率: -43.86%

总交易次数: 29
盈利交易: 11 (39.29%)
亏损交易: 17
夏普比率: -1.11
最大回撤: 65.26%
```

## 策略说明

当前使用的是**双均线策略**：
- 快线周期：20分钟
- 慢线周期：60分钟
- RSI过滤：超买阈值70，超卖阈值30

### 买入条件
1. 快线上穿慢线（金叉）
2. RSI < 70（不在超买区）

### 卖出条件
1. 快线下穿慢线（死叉），或
2. RSI > 70（超买）

## 自定义配置

### 修改初始资金和手续费

如需修改初始资金和手续费，编辑 `backtrader_demo.py` 的相关部分：

```python
# 初始资金
cerebro.broker.setcash(100000)  # 默认10万美元

# 手续费
cerebro.broker.setcommission(commission=0.001)  # 默认0.1%
```

### 修改策略参数

系统会根据K线周期自动调整策略参数，如需手动调整，可以修改 `strategy_params` 字典：

```python
strategy_params = {
    'm1': {'fast_period': 20, 'slow_period': 60},
    'm5': {'fast_period': 20, 'slow_period': 60},
    'm15': {'fast_period': 15, 'slow_period': 45},
    'm30': {'fast_period': 10, 'slow_period': 30},
    'h1': {'fast_period': 10, 'slow_period': 30},
    'h4': {'fast_period': 5, 'slow_period': 15},
    'd1': {'fast_period': 5, 'slow_period': 20},
}
```

## 核心功能

### 1. 自动K线转换
程序使用Backtrader的 `resampledata()` 方法，自动将1分钟原始数据转换为指定周期：
- 支持7种K线周期：m1, m5, m15, m30, h1, h4, d1
- 自动根据周期调整策略参数
- 保持数据完整性和准确性

### 2. 自定义组件
代码包含多个可复用的组件：
- **自定义指标**: MyMomentum（动量指标）、DoubleMA（双均线差值）
- **自定义分析器**: MyTradeStats（交易统计）、MonthlyReturnsAnalyzer（月度收益）
- **仓位管理**: PercentRiskSizer（风险百分比）、KellySizer（凯利公式）
- **手续费模型**: StockCommission（A股手续费）
- **策略示例**: CompleteStrategy（完整策略）、SignalStrategy（信号策略）

## 数据统计

### 时间范围
- 2020-01-01 23:00:00 到 2025-12-19 21:59:00

### 价格统计
- 最低价: 2,995.00 (2020年疫情期间)
- 最高价: 26,805.00 (2025年)
- 平均价: 14,985.35

## 注意事项

1. **数据量大**：210万行数据，运行时间较长（2024年一年数据约1-2分钟）
2. **内存占用**：建议8GB以上内存
3. **策略优化**：当前策略仅供演示，实际使用需要根据市场情况优化参数
4. **最大回撤**：98.91%回撤较大，实盘需要增加风险控制

## 下一步优化建议

1. **参数优化**：使用 `run_optimization()` 找到最优参数组合
2. **止损止盈**：添加止损和止盈逻辑
3. **风险管理**：优化仓位管理，控制单笔风险
4. **多策略**：结合多个指标（MACD、布林带等）
5. **时间过滤**：只在交易活跃时段交易

## 技术支持

如有问题，请检查：
1. 数据文件是否存在且格式正确
2. Python环境是否安装了 backtrader 和 pandas
3. 内存是否充足

